<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Thursday, March 16, 2017, 11:51 AM -->
<!-- MuClient version 4.94 -->

<!-- Plugin "Lotj_Voter" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Lotj_Voter"
   author="Xavious"
   id="03b5ecafcfde268119c55d3b"
   language="Lua"
   purpose="Vote for Lotj on TMC"
   save_state="y"
   date_written="2017-03-16 11:51:03"
   requires="4.94"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Aliases  -->

<aliases>
  <alias
   match="vote now"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	vote()
  </send>
  </alias>
  <alias
   match="vote help"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	showHelp()
  </send>
  </alias>
  <alias
   match="vote set username *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setUsername("%1")
  </send>
  </alias>
  <alias
   match="vote set password *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setPassword("%1")
  </send>
  </alias>
  <alias
   match="vote set time *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setTime("%1")
  </send>
  </alias>
  <alias
   match="vote set auto *"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>
	setAuto("%1")
  </send>
  </alias>
</aliases>

<!--  Script  -->


<script>
<![CDATA[
function showHelp()
	username = GetVariable("username")
	password = GetVariable("password")
	hour = GetVariable("hour")..":00"
	auto = GetVariable("auto")
	
	Note("____________________________")
	Note("       Lotj Voter       ")
	Note("----------------------------")
	Note("Username: "..username)
	Note("Password: "..password)
	Note("VoteTime: "..hour)
	Note("AutoVote: "..auto)
	Note("----------------------------")
	Note("         Commands           ")
	Note("----------------------------")
	Note("vote set username <username>")
	Note("vote set password <password>")
	Note("vote set time <0-23>")
	Note("vote set auto <on/off>")
	Note("vote help")
	Note("vote now")
	Note("----------------------------")
end

function setUsername(username)
	SetVariable("username", username)
	Note("Username set to: "..username)
end

function setPassword(password)
	SetVariable("password", password)
	Note("Password set to: "..password)
end

function setTime(hour)
	hour = tonumber(hour)
	auto = GetVariable("auto")
	if string.lower(auto) == "on" then
		enable = 1
	else
		enable = 0
	end
	if type(hour) == "number" and hour >= 0 and hour <= 23 then
		hour = math.floor(hour)
		SetVariable("hour", hour)
		AddTimer("VoteTimer", hour, 0, 0, "vote()", timer_flag.Replace + timer_flag.ActiveWhenClosed + timer_flag.AtTime + enable)
		SetTimerOption("VoteTimer", "send_to", 12)
		Note("Vote time set to: "..hour..":00")
	else
		Note("Invalid time. Must be an hour bewteen 0 and 23")
	end
end

function setAuto(auto)
	if string.lower(auto) == "on" then
		SetVariable("auto", "on")
		EnableTimer("VoteTimer", true)
		ResetTimer("VoteTimer")
		Note("Auto voting enabled.")
	elseif string.lower(auto) == "off" then
		SetVariable("auto", "off")
		EnableTimer("VoteTimer", false)
		Note("Auto voting disabled.")
	else
		Note("Invalid option.")
	end
end

function vote()
	session = postLogin()
	if session then
		postVote(session)
	end
end

function postLogin()
	username = GetVariable("username")
	password = GetVariable("password")
	http = require "socket.http"
	url = "http://www.mudconnect.com/SMF/index.php?action=login2"
	reqbody = "user="..username.."&passwrd="..password.."&cookie=60&hash_passwrd="
	Note("Attempting to login to TMC..")
	b, c, h, s = http.request(url,reqbody)
	--Parse the session ID and forum cookie from the set-cookie response header.
	if c == 200 then
		if string.match(b, "That%s+username%s+does%s+not%s+exist") then
			Note("TMC: That username does not exist.")
		elseif string.match(b, "Password%s+incorrect") then
			Note("TMC: Password incorrect.")
		elseif string.match(b, "You%s+need%s+to%s+fill%s+in%s+a%s+username.") then
			Note("TMC: You need to fill in a username.")
		elseif string.match(b, "You%s+didn't%s+enter%s+your%s+password.") then
			Note("TMC: You didn't enter your password.")
		else
			Note(b)
			Note("Unknown error while attempting to login.")
		end
	elseif c == 302 then
		php_session = string.match(h["set-cookie"], 'PHPSESSID=[%w]+;')
		cookie = string.match(h["set-cookie"], 'SMFCookie474=[%w%%]+;')
		if php_session ~= nil and cookie ~= nil then
			Note("Login successful.")
			session = php_session.." "..cookie
			return session
		else
			Note("Error parsing session data.")
		end
	else
		Note("Unexpected HTTP code.")
	end

end

function postVote(session)
	require 'socket.http'
	local request_body = "mode=VOTE_CONF&mud=Legends+of+the+Jedi&imgsrc="
	local response_body = { }
	Note("Attempting to place vote.")
	local b, c, h = socket.http.request
	{
	  url = "http://www.mudconnect.com/cgi-bin/vote_rank.cgi",
	  method = "POST",
	  headers = 
	  {
		["Content-Type"] = "application/x-www-form-urlencoded",
		["Referer"] = "http://www.mudconnect.com/cgi-bin/vote_rank.cgi?mud=Legends+of+the+Jedi",
		["Cookie"] = session,
		["Content-Length"] = #request_body,
	  };
	  source = ltn12.source.string(request_body);
	  sink = ltn12.sink.table(response_body)
	}
	
	b = table.concat(response_body)
	if c == 200 then
		if string.match(b, "You%s+have%s+already%s+cast%s+your%s+vote%s+for%s+today,%s+please%s+be%s+sure%s+to%s+return%s+tomorrow%s+to%s+vote%s+again!") then
			Note("TMC: You have already cast your vote for today, please be sure to return tomorrow to vote again!")
		else
			Note("Unexpected response for code: "..c)
		end
	elseif c == 302 then
		Note("Vote successful.")
	elseif c == 500 then
		Note("Error. Unexpected code: "..c)
		Note("Try again.")
	else
		Note("Error. Unexpected code: "..c)
	end
end

function OnPluginInstall ()
	username = GetVariable("username")
	if username == nil then
		SetVariable("username", "Undefined")
	end
	password = GetVariable("password")
	if password == nil then
		SetVariable("password", "Undefined")
	end
	hour = GetVariable("hour")
	if hour == nil then
		SetVariable("hour", "0")
	else
		setTime(hour)
	end
	auto = GetVariable("auto")
	if auto == nil then
		SetVariable("auto", "off")
	else
		setAuto(auto)
	end
	showHelp()
end 

]]>
</script>


</muclient>
